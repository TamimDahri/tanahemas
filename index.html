<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tanahemas ‚Äì Add Place (with Debug)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Set this if your API is on another origin. Leave empty for same-origin. -->
  <meta name="api-base" content="">
  <style>
    :root { --ok:#16a34a; --warn:#ca8a04; --err:#dc2626; --ink:#e5e7eb; --fg:#111827; --bg:#0b1020; --card:#111827; }
    html,body{margin:0;padding:0;background:#0b1020;color:#e5e7eb;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    .wrap{max-width:900px;margin:40px auto;padding:24px}
    h1{margin:0 0 8px;font-size:22px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:18px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    label{display:block;margin:.75rem 0 .25rem;font-weight:600}
    input,select,textarea,button{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;padding:10px 12px}
    textarea{min-height:80px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;align-items:center;margin-top:12px}
    button{cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .status{margin-top:10px;font-weight:700}
    .status.ok{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .status.err{color:var(--err)}
    details{margin-top:18px}
    summary{cursor:pointer;font-weight:700}
    pre{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:12px;overflow:auto;max-height:360px}
    .muted{opacity:.8;font-size:13px}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .pill{border:1px solid #334155;border-radius:999px;padding:2px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tambah Tempat</h1>
    <div class="card">
      <form id="placeForm" novalidate>
        <label for="name">Nama Tempat *</label>
        <input id="name" name="name" placeholder="cth: Surau Al-Hidayah" required />

        <label for="type">Jenis *</label>
        <select id="type" name="type" required>
          <option value="masjid">Masjid</option>
          <option value="surau">Surau</option>
          <option value="sekolah">Sekolah</option>
          <option value="lain">Lain-lain</option>
        </select>

        <label for="address">Alamat (optional)</label>
        <textarea id="address" name="address" placeholder="Alamat penuh atau keterangan ringkas"></textarea>

        <div class="row">
          <div>
            <label for="lat">Latitud *</label>
            <input id="lat" name="lat" type="number" step="any" placeholder="2.9224" required />
          </div>
          <div>
            <label for="lng">Longitud *</label>
            <input id="lng" name="lng" type="number" step="any" placeholder="101.6557" required />
          </div>
        </div>

        <div class="actions">
          <button id="submitBtn" type="submit">Simpan</button>
          <button id="testBtn" type="button" title="GET /places untuk uji API">Uji GET /places</button>
          <span class="muted">* Medan wajib</span>
        </div>

        <div id="status" class="status">Menunggu input‚Ä¶</div>

        <details open>
          <summary class="inline">Debug <span id="debugBadge" class="pill">0 log</span></summary>
          <div class="actions">
            <button id="clearDbg" type="button">Clear Debug</button>
            <button id="copyDbg" type="button">Copy Debug</button>
          </div>
          <pre id="debug"></pre>
        </details>
      </form>
    </div>
    <p class="muted" style="margin-top:10px">
      Petua: Jika API di domain lain, set <code>&lt;meta name="api-base" content="https://tanahemas.onrender.com"&gt;</code>.
      Jika sama origin, biarkan kosong.
    </p>
  </div>

  <script>
    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    const dbgEl = $('debug');
    const badgeEl = $('debugBadge');
    const apiBase = document.querySelector('meta[name="api-base"]')?.content?.trim() || '';

    let dbgCount = 0;
    function setStatus(msg, kind='') {
      statusEl.className = 'status ' + (kind||'');
      statusEl.textContent = msg;
      log({ status: msg, level: kind || 'info' });
    }
    function log(thing, label) {
      dbgCount++;
      badgeEl.textContent = `${dbgCount} log`;
      const time = new Date().toLocaleTimeString();
      const head = label ? `# ${time} ‚Äî ${label}\n` : `# ${time}\n`;
      let body;
      try {
        body = typeof thing === 'string' ? thing : JSON.stringify(thing, null, 2);
      } catch(e) {
        body = String(thing);
      }
      dbgEl.textContent += head + body + '\n\n';
      dbgEl.scrollTop = dbgEl.scrollHeight;
    }
    function clearDebug() {
      dbgEl.textContent = '';
      dbgCount = 0;
      badgeEl.textContent = '0 log';
    }
    async function copyDebug() {
      await navigator.clipboard.writeText(dbgEl.textContent || '');
      setStatus('‚úÖ Debug copied to clipboard.', 'ok');
    }
    function requiredStr(v){ return (v ?? '').toString().trim(); }
    function requiredNum(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }

    // Optional: abort slow requests after 15s
    function withTimeout(ms=15000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(new Error('Timeout')), ms);
      return { signal: ctrl.signal, cancel: ()=>clearTimeout(t) };
    }

    // ===== Submit handler =====
    $('placeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = $('submitBtn');
      btn.disabled = true;

      // Gather + validate
      const payload = {
        name:    requiredStr($('name').value),
        type:    requiredStr($('type').value || 'lain'),
        address: requiredStr($('address').value),
        lat:     requiredNum($('lat').value),
        lng:     requiredNum($('lng').value),
      };
      log(payload, 'Payload (about to POST)');

      if (!payload.name) {
        setStatus('‚ùå Ralat: "Nama Tempat" wajib.', 'err'); btn.disabled = false; return;
      }
      if (!Number.isFinite(payload.lat) || !Number.isFinite(payload.lng)) {
        setStatus('‚ùå Ralat: Koordinat tidak sah (lat/lng).', 'err'); btn.disabled = false; return;
      }

      // Fire request
      const url = apiBase + '/places';
      const { signal, cancel } = withTimeout(15000);
      setStatus('‚è≥ Menyimpan data‚Ä¶', 'warn');
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal
        });
        cancel();

        // Read body safely (text first, then try JSON)
        const raw = await res.text();
        let json; try { json = JSON.parse(raw); } catch { /* keep raw */ }

        // Debug dump
        const headersObj = {};
        res.headers.forEach((v,k)=>headersObj[k]=v);
        log({ request: { url, method:'POST' },
              response: { ok: res.ok, status: res.status, statusText: res.statusText, headers: headersObj },
              body: json ?? raw
            }, 'Response');

        if (!res.ok) {
          setStatus(`‚ùå Gagal (${res.status}): ${json?.error || json?.message || raw || 'Ralat tidak diketahui.'}`, 'err');
          return;
        }

        setStatus('‚úÖ Berjaya disimpan!', 'ok');
        // Optionally reset form after success
        e.target.reset();
      } catch (err) {
        log({ error: (err && err.message) || String(err) }, 'Fetch Error');
        const reason = (err && err.name === 'AbortError') ? 'Timeout' : (err && err.message) || 'Ralat rangkaian';
        setStatus(`‚ùå Gagal hantar: ${reason}`, 'err');
      } finally {
        btn.disabled = false;
      }
    });

    // ===== Test GET /places =====
    $('testBtn').addEventListener('click', async () => {
      const url = apiBase + '/places';
      const { signal, cancel } = withTimeout(10000);
      setStatus('üîé Uji GET /places‚Ä¶', 'warn');
      try {
        const res = await fetch(url, { signal });
        cancel();
        const raw = await res.text();
        let json; try { json = JSON.parse(raw); } catch {}
        const headersObj = {};
        res.headers.forEach((v,k)=>headersObj[k]=v);
        log({ request: { url, method:'GET' },
              response: { ok: res.ok, status: res.status, statusText: res.statusText, headers: headersObj },
              body: json ?? raw
            }, 'GET /places');
        if (!res.ok) {
          setStatus(`‚ùå GET gagal (${res.status})`, 'err');
        } else {
          setStatus('‚úÖ GET berjaya. Lihat Debug untuk senarai.', 'ok');
        }
      } catch (err) {
        log({ error: (err && err.message) || String(err) }, 'GET Error');
        setStatus('‚ùå GET gagal: ' + ((err && err.message) || 'Ralat rangkaian'), 'err');
      }
    });

    // ===== Debug buttons =====
    $('clearDbg').addEventListener('click', clearDebug);
    $('copyDbg').addEventListener('click', copyDebug);

    // First boot info
    log({ apiBase: apiBase || '(same-origin)' }, 'Boot');
    setStatus('‚úÖ Sedia. Masukkan data dan tekan Simpan.', 'ok');
  </script>
</body>
</html>

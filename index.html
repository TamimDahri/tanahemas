<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tanah Emas - Selangor Land Viewer</title>
  <link rel="icon" href="te.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; }
    #map { height: 100%; width: 100%; }
    #panel {
      position: absolute; top: 15px; left: 15px; z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      width: 280px;
    }
    h2 { margin-top: 0; font-size: 18px; text-align: center; color: #d4a017; }
    select, button {
      width: 100%;
      padding: 6px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    #msg { margin-top: 10px; font-size: 13px; color: #333; text-align: center; }

    /* Lot number label styling */
    .lot-label {
      background: none;
      font-size: 11px;
      color: #000;
      text-shadow: 0 0 2px #fff;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .lot-label.visible { opacity: 1; }
  </style>
</head>
<body>

<div id="panel">
  <h2>üè° Tanah Emas Viewer</h2>

  <label><b>Select Daerah (Selangor)</b></label>
  <select id="daerah">
    <option value="">-- Choose Daerah --</option>
  </select>

  <label><b>Select Mukim</b></label>
  <select id="mukim">
    <option value="">-- Choose Mukim --</option>
  </select>

  <button id="load">Load Lots</button>
  <p id="msg">Status: waiting...</p>
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([3.05, 101.6], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const msg = document.getElementById("msg");
const daerahSelect = document.getElementById("daerah");
const mukimSelect = document.getElementById("mukim");

let geoLayer = null;
let labelLayer = L.layerGroup().addTo(map);
let currentData = null;

// üó∫Ô∏è Selangor Daerah & Mukim Reference
const selangorData = {
  "01": { name: "Gombak", mukim: { "01": "Setapak", "02": "Ulu Klang", "03": "Rawang" } },
  "02": { name: "Hulu Langat", mukim: { "01": "Kajang", "02": "Cheras", "03": "Hulu Langat" } },
  "03": { name: "Hulu Selangor", mukim: { "01": "Ampang Pecah", "02": "Batang Kali", "03": "Ulu Bernam" } },
  "04": { name: "Klang", mukim: { "01": "Kapar", "02": "Klang" } },
  "05": { name: "Kuala Langat", mukim: { "01": "Telok Panglima Garang", "02": "Tanjong Dua Belas", "03": "Batu" } },
  "06": { name: "Kuala Selangor", mukim: { "01": "Ijok", "02": "Jeram", "03": "Tanjong Karang" } },
  "07": { name: "Petaling", mukim: { "04": "Petaling", "05": "Damansara", "06": "Bukit Raja" } },
  "08": { name: "Sabak Bernam", mukim: { "01": "Sabak", "02": "Sungai Panjang" } },
  "09": { name: "Sepang", mukim: { "01": "Dengkil", "02": "Sepang", "03": "Labu" } }
};

// Populate Daerah dropdown
for (const [code, d] of Object.entries(selangorData)) {
  const opt = document.createElement("option");
  opt.value = code;
  opt.textContent = `${d.name} (${code})`;
  daerahSelect.appendChild(opt);
}

// Update Mukim dropdown dynamically
daerahSelect.addEventListener("change", () => {
  const daerahCode = daerahSelect.value;
  mukimSelect.innerHTML = '<option value="">-- Choose Mukim --</option>';
  if (!daerahCode) return;

  const mukimList = selangorData[daerahCode].mukim;
  for (const [code, name] of Object.entries(mukimList)) {
    const opt = document.createElement("option");
    opt.value = code;
    opt.textContent = `${name} (${code})`;
    mukimSelect.appendChild(opt);
  }
});

// Fetch and show data
document.getElementById("load").addEventListener("click", async () => {
  const daerah = daerahSelect.value;
  const mukim = mukimSelect.value;
  if (!daerah || !mukim) {
    msg.textContent = "‚ö†Ô∏è Please select both Daerah and Mukim.";
    return;
  }

  msg.textContent = `‚è≥ Loading lots for ${selangorData[daerah].name}, Mukim ${mukim}...`;
  labelLayer.clearLayers();
  currentData = null;

  const url = `https://scharms.planmalaysia.gov.my/arcgis/rest/services/iPLAN/LOT_10/MapServer/0/query?where=NEGERI='10'+AND+DAERAH='${daerah}'+AND+MUKIM='${mukim}'&outFields=LOT,UPI,DAERAH,MUKIM,KELUASAN&f=geojson`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    currentData = data;

    if (geoLayer) map.removeLayer(geoLayer);
    if (data.features && data.features.length > 0) {
      geoLayer = L.geoJSON(data, {
        renderer: L.canvas({ tolerance: 5 }),
        onEachFeature: (feature, layer) => {
          const p = feature.properties;
          layer.bindPopup(`
            <b>Lot:</b> ${p.LOT}<br>
            <b>UPI:</b> ${p.UPI}<br>
            <b>Daerah:</b> ${p.DAERAH}<br>
            <b>Mukim:</b> ${p.MUKIM}<br>
            <b>Keluasan:</b> ${p.KELUASAN?.toLocaleString() || '-'} m¬≤
          `);
        },
        style: { color: "#d4a017", weight: 1 }
      }).addTo(map);

      const bounds = geoLayer.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds);

      msg.innerHTML = `‚úÖ Loaded ${data.features.length} lots for ${selangorData[daerah].name} (Mukim ${mukim}). Zoom in to see lot numbers.`;
      updateLabels();
    } else {
      msg.textContent = "‚ö†Ô∏è No lots found for this area.";
    }
  } catch (err) {
    msg.textContent = "‚ùå Error loading data: " + err.message;
  }
});

// Show lot numbers when zoomed in
function updateLabels() {
  labelLayer.clearLayers();
  if (!currentData) return;

  const zoom = map.getZoom();
  if (zoom < 17) return; // only show when zoomed in close

  const features = currentData.features.slice(0, 2000);
  features.forEach(f => {
    const p = f.properties;
    if (!p.LOT) return;
    const geom = L.geoJSON(f);
    const center = geom.getBounds().getCenter();
    const div = L.divIcon({
      className: "lot-label visible",
      html: p.LOT,
      iconSize: null
    });
    L.marker(center, { icon: div, interactive: false }).addTo(labelLayer);
  });
}

map.on("zoomend", updateLabels);
</script>
</body>
</html>
